<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ß–∞—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏ - –ê–¥–º–∏–Ω–∫–∞</title>
    <style>
        body { font-family: Arial; background: #0a0a0a; color: white; margin: 0; padding: 20px; }
        .chat-container { max-width: 1000px; margin: 0 auto; }
        #messages { height: 500px; overflow-y: auto; background: #1a1a1a; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        .message { margin: 10px 0; padding: 10px 15px; border-radius: 8px; max-width: 80%; }
        .user { background: #2c5282; margin-left: auto; }
        .support { background: #2d3748; }
        .input-area { display: flex; margin-bottom: 20px; }
        input { flex: 1; padding: 12px; background: #0a0a0a; border: 1px solid #333; color: white; border-radius: 8px; }
        button { background: #667eea; color: white; padding: 12px 20px; border: none; border-radius: 8px; margin-left: 10px; cursor: pointer; }
        .sessions { background: #1a1a1a; padding: 15px; border-radius: 10px; margin-top: 20px; }
        .session { padding: 10px; border-bottom: 1px solid #333; cursor: pointer; }
        .session:hover { background: #222; }
        .session.active { background: #2c5282; }
    </style>
</head>
<body>
    <div class="chat-container">
        <h2>üí¨ –ê–¥–º–∏–Ω-—á–∞—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏</h2>
        
        <div class="input-area">
            <input type="text" id="message-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
            <button id="send-btn">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤—Å–µ–º</button>
            <button id="support-btn" style="background: #4caf50;">üí¨ –û—Ç–≤–µ—Ç–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É</button>
        </div>
        
        <div id="messages"></div>
        
        <div class="sessions">
            <h3>üìÅ –ê–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏</h3>
            <div id="sessions-list">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
        
        <div style="margin-top: 20px; color: #666; font-size: 14px;">
            <p>–°—Ç–∞—Ç—É—Å WebSocket: <span id="status">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</span></p>
            <p>–ê–∫—Ç–∏–≤–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤: <span id="clients-count">0</span></p>
        </div>
    </div>

    <script>
    let ws = null;
    let currentSessionId = null;
    
    function connectWebSocket() {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}`;
        
        ws = new WebSocket(wsUrl);
        
        ws.onopen = () => {
            console.log('‚úÖ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω');
            document.getElementById('status').textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω';
        };
        
        ws.onmessage = (event) => {
            try {
                const data = JSON.parse(event.data);
                
                if (data.type === 'connected') {
                    console.log('–ü–æ–¥–∫–ª—é—á–µ–Ω–∞ —Å–µ—Å—Å–∏—è:', data.sessionId);
                    updateSessionsList();
                }
                else if (data.type === 'chat_message') {
                    // –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞
                    const messagesDiv = document.getElementById('messages');
                    messagesDiv.innerHTML += `
                        <div class="message user" data-session="${data.sessionId}" onclick="selectSession('${data.sessionId}')">
                            <strong>üë§ ${data.user || '–ö–ª–∏–µ–Ω—Ç'} (${data.sessionId.substring(0, 8)}):</strong><br>
                            ${data.text}
                            <div style="font-size: 12px; color: #888;">${data.time}</div>
                        </div>
                    `;
                    messagesDiv.scrollTop = messagesDiv.scrollHeight;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Å–µ—Å—Å–∏–π
                    updateSessionsList();
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
            }
        };
        
        ws.onclose = () => {
            console.log('‚ùå WebSocket –æ—Ç–∫–ª—é—á–µ–Ω');
            document.getElementById('status').textContent = '–û—Ç–∫–ª—é—á–µ–Ω';
            
            // –ü—Ä–æ–±—É–µ–º –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è
            setTimeout(connectWebSocket, 3000);
        };
    }
    
    function sendMessageToAll() {
        const input = document.getElementById('message-input');
        const message = input.value.trim();
        
        if (!message || !ws) return;
        
        ws.send(JSON.stringify({
            type: 'support_message',
            text: message
        }));
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Å–≤–æ—ë —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç
        const messagesDiv = document.getElementById('messages');
        messagesDiv.innerHTML += `
            <div class="message support">
                <strong>üõ†Ô∏è –ü–æ–¥–¥–µ—Ä–∂–∫–∞:</strong><br>
                ${message}
                <div style="font-size: 12px; color: #888;">${new Date().toLocaleTimeString('ru-RU')}</div>
            </div>
        `;
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
        
        input.value = '';
    }
    
    function selectSession(sessionId) {
        currentSessionId = sessionId;
        
        // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é —Å–µ—Å—Å–∏—é
        document.querySelectorAll('.session').forEach(el => {
            el.classList.remove('active');
            if (el.dataset.session === sessionId) {
                el.classList.add('active');
            }
        });
        
        document.getElementById('support-btn').textContent = `üí¨ –û—Ç–≤–µ—Ç–∏—Ç—å —Å–µ—Å—Å–∏–∏ ${sessionId.substring(0, 8)}`;
    }
    
    function updateSessionsList() {
        // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –±—ã–ª –±—ã –∑–∞–ø—Ä–æ—Å –∫ —Å–µ—Ä–≤–µ—Ä—É
        // –ü–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫
        const count = document.querySelectorAll('.message.user').length;
        document.getElementById('clients-count').textContent = count;
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('send-btn').onclick = sendMessageToAll;
        document.getElementById('support-btn').onclick = sendMessageToAll;
        
        document.getElementById('message-input').onkeypress = (e) => {
            if (e.key === 'Enter') sendMessageToAll();
        };
        
        connectWebSocket();
    });
    </script>
</body>
</html>
