<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ß–∞—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏ - N ‚Ä¢ PC</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" type="image/png" href="images/logo.png">
    <style>
        .chat-admin-container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 1.5rem;
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 2rem;
            height: calc(100vh - 120px);
        }

        .chat-sidebar {
            background: #1a1a1a;
            border: 1px solid #333333;
            border-radius: 12px;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-main {
            background: #1a1a1a;
            border: 1px solid #333333;
            border-radius: 12px;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-list {
            flex: 1;
            overflow-y: auto;
            margin-top: 1rem;
        }

        .chat-user {
            padding: 1rem;
            background: #222222;
            border: 1px solid #333333;
            border-radius: 8px;
            margin-bottom: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .chat-user:hover {
            background: #252525;
            border-color: #555555;
        }

        .chat-user.active {
            background: #2a2a2a;
            border-color: #4caf50;
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.2);
        }

        .chat-user-name {
            font-weight: bold;
            color: white;
            margin-bottom: 0.3rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-user-last {
            font-size: 0.85rem;
            color: #999;
            margin-bottom: 0.5rem;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .chat-user-time {
            font-size: 0.75rem;
            color: #666;
        }

        .unread-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #4caf50;
            color: white;
            font-size: 0.75rem;
            padding: 0.2rem 0.5rem;
            border-radius: 10px;
            font-weight: bold;
            min-width: 20px;
            text-align: center;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            border: 1px solid #333333;
            border-radius: 8px;
            margin-bottom: 1rem;
            background: #0a0a0a;
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
        }

        .message-input-area {
            display: flex;
            gap: 0.8rem;
            background: #222222;
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid #333333;
        }

        .message-input-area textarea {
            flex: 1;
            padding: 0.8rem;
            background: #0a0a0a;
            border: 1px solid #333333;
            border-radius: 6px;
            color: white;
            resize: none;
            height: 60px;
            font-family: inherit;
            font-size: 0.95rem;
        }

        .message-input-area textarea:focus {
            outline: none;
            border-color: #4caf50;
        }

        .send-btn {
            background: #4caf50;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 0 1.5rem;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            align-self: flex-end;
            height: 60px;
        }

        .send-btn:hover:not(:disabled) {
            background: #45a049;
            transform: translateY(-1px);
        }

        .send-btn:disabled {
            background: #333333;
            cursor: not-allowed;
            opacity: 0.5;
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 1rem;
            border-bottom: 1px solid #333333;
            flex-shrink: 0;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .online {
            background: #4caf50;
            box-shadow: 0 0 10px #4caf50;
        }

        .offline {
            background: #f44336;
        }

        .no-chats {
            text-align: center;
            padding: 3rem 1rem;
            color: #666;
        }

        .no-chats-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .chat-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .session-id {
            background: #333333;
            padding: 0.3rem 0.6rem;
            border-radius: 4px;
            font-size: 0.8rem;
            color: #999;
            font-family: monospace;
        }

        .message {
            padding: 0.8rem 1rem;
            border-radius: 12px;
            max-width: 80%;
            word-wrap: break-word;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.system {
            background: #2c3e50;
            color: white;
            align-self: center;
            max-width: 90%;
            border: 1px solid #3a506b;
            text-align: center;
        }

        .message.support {
            background: linear-gradient(135deg, #1a5276 0%, #21618c 100%);
            color: white;
            align-self: flex-start;
            border: 1px solid #2874a6;
        }

        .message.user {
            background: linear-gradient(135deg, #333333 0%, #444444 100%);
            color: white;
            align-self: flex-end;
            border: 1px solid #555555;
        }

        .message-header {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .message-sender {
            font-weight: bold;
            margin-right: 0.8rem;
        }

        .message-time {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.8rem;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–∫—Ä–æ–ª–ª–±–∞—Ä–∞ */
        .chat-list::-webkit-scrollbar,
        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-list::-webkit-scrollbar-track,
        .chat-messages::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        .chat-list::-webkit-scrollbar-thumb,
        .chat-messages::-webkit-scrollbar-thumb {
            background: #444444;
            border-radius: 3px;
        }

        .chat-list::-webkit-scrollbar-thumb:hover,
        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: #555555;
        }
    </style>
</head>
<body>
    <header>
        <nav class="navbar">
            <div class="logo">N ‚Ä¢ PC | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —á–∞—Ç–∞</div>
            <ul class="nav-links">
                <li><a href="admin.html">üìä –ó–∞—è–≤–∫–∏</a></li>
                <li><a href="index.html">üè† –ù–∞ —Å–∞–π—Ç</a></li>
                <li><a href="#" onclick="logout()">üö™ –í—ã–π—Ç–∏</a></li>
            </ul>
        </nav>
    </header>

    <main class="chat-admin-container">
        <div class="chat-sidebar">
            <div class="admin-header">
                <h2>–ê–∫—Ç–∏–≤–Ω—ã–µ —á–∞—Ç—ã</h2>
                <div id="connection-status" style="font-size: 0.9rem;">
                    <span class="status-indicator offline"></span>
                    <span>–û—Ç–∫–ª—é—á–µ–Ω–æ</span>
                </div>
            </div>
            <div class="chat-list" id="chatList">
                <div class="no-chats">
                    <div class="no-chats-icon">üí¨</div>
                    <p>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —á–∞—Ç–æ–≤</p>
                    <p style="font-size: 0.9rem; margin-top: 0.5rem;">–ü–æ–¥–æ–∂–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤</p>
                </div>
            </div>
        </div>

        <div class="chat-main">
            <div class="admin-header">
                <div>
                    <h2 id="current-chat-name">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</h2>
                    <div id="current-session" class="session-id" style="display: none;">ID: <span></span></div>
                </div>
                <div id="support-status">
                    <span class="status-indicator offline"></span>
                    <span>–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞</span>
                </div>
            </div>
            
            <div class="chat-messages" id="chatMessages">
                <div class="message system">
                    <div class="message-header">
                        <span>ü§ñ –°–∏—Å—Ç–µ–º–∞</span>
                    </div>
                    <p>üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —á–∞—Ç–æ–º!</p>
                    <p style="font-size: 0.9rem; margin-top: 5px;">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç —Å–ª–µ–≤–∞ –¥–ª—è –Ω–∞—á–∞–ª–∞ –æ–±—â–µ–Ω–∏—è</p>
                </div>
            </div>
            
            <div class="message-input-area">
                <textarea id="messageInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." disabled></textarea>
                <button class="send-btn" id="sendBtn" onclick="sendMessage()" disabled>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </main>

   <script>
    class ChatAdmin {
        constructor() {
            this.ws = null;
            this.isConnected = false;
            this.supportOnline = false;
            this.currentChat = null;
            this.chats = new Map(); // sessionId -> chat data
            this.init();
        }

        init() {
            this.connectWebSocket();
            this.setupEventListeners();
            
            // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            if ("Notification" in window && Notification.permission === "default") {
                Notification.requestPermission();
            }
        }

        connectWebSocket() {
            try {
                // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫–∞–∫ –ø–æ–¥–¥–µ—Ä–∂–∫–∞
                this.ws = new WebSocket(`ws://localhost:3000/?support=true`);
                
                this.ws.onopen = () => {
                    console.log('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —á–∞—Ç—É –ø–æ–¥–¥–µ—Ä–∂–∫–∏');
                    this.isConnected = true;
                    this.updateConnectionStatus(true);
                    this.updateSupportStatus(true);
                };
                
                this.ws.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        this.handleMessage(data);
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
                    }
                };
                
                this.ws.onclose = () => {
                    console.log('‚ùå –û—Ç–∫–ª—é—á–µ–Ω–æ –æ—Ç —á–∞—Ç–∞');
                    this.isConnected = false;
                    this.updateConnectionStatus(false);
                    this.updateSupportStatus(false);
                    
                    setTimeout(() => this.connectWebSocket(), 3000);
                };
                
                this.ws.onerror = (error) => {
                    console.error('–û—à–∏–±–∫–∞ WebSocket:', error);
                    this.updateConnectionStatus(false);
                    this.updateSupportStatus(false);
                };
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:', error);
            }
        }

        handleMessage(data) {
            switch (data.type) {
                case 'support_status':
                    this.supportOnline = data.online;
                    this.updateSupportStatus(data.online);
                    break;
                    
                case 'active_chats':
                    this.updateChatList(data.chats);
                    break;
                    
                case 'message':
                    this.handleChatMessage(data);
                    break;
                    
                case 'chat_history':
                    this.displayChatHistory(data);
                    break;
            }
        }

        handleChatMessage(data) {
            const sessionId = data.sessionId;
            
            // –ü–æ–ª—É—á–∞–µ–º –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º —á–∞—Ç
            if (!this.chats.has(sessionId)) {
                this.chats.set(sessionId, {
                    id: sessionId,
                    userName: data.userName || `–ì–æ—Å—Ç—å ${this.chats.size + 1}`,
                    messages: [],
                    unread: 0
                });
            }
            
            const chat = this.chats.get(sessionId);
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ (–µ—Å–ª–∏ –µ–≥–æ –µ—â–µ –Ω–µ—Ç)
            const messageExists = chat.messages.some(msg => 
                msg.text === data.text && 
                msg.sender === data.sender && 
                msg.timestamp === data.timestamp
            );
            
            if (!messageExists) {
                chat.messages.push({
                    sender: data.sender,
                    text: data.text,
                    timestamp: data.timestamp,
                    read: data.sender === 'support'
                });
                
                chat.lastActivity = new Date();
                chat.lastMessage = data.text;
                
                // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                if (data.sender === 'user') {
                    chat.unread++;
                    
                    // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–æ–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
                    if (this.currentChat !== sessionId) {
                        this.showNotification(chat.userName, data.text);
                    }
                }
                
                // –ï—Å–ª–∏ —ç—Ç–æ —Ç–µ–∫—É—â–∏–π –æ—Ç–∫—Ä—ã—Ç—ã–π —á–∞—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                if (this.currentChat === sessionId) {
                    this.displayMessage(data);
                    chat.unread = 0; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ
                    
                    // –û—Ç–º–µ—á–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ
                    chat.messages.forEach(msg => {
                        if (msg.sender === 'user') {
                            msg.read = true;
                        }
                    });
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤
                this.updateChatList();
            }
        }

        updateChatList(chatsData) {
            const chatList = document.getElementById('chatList');
            
            // –ï—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω –º–∞—Å—Å–∏–≤ —á–∞—Ç–æ–≤, –æ–±–Ω–æ–≤–ª—è–µ–º
            if (chatsData) {
                chatsData.forEach(chatData => {
                    if (!this.chats.has(chatData.id)) {
                        this.chats.set(chatData.id, {
                            id: chatData.id,
                            userName: chatData.userName,
                            messages: [],
                            unread: chatData.unread || 0,
                            lastActivity: new Date(chatData.lastActivity),
                            lastMessage: chatData.lastMessage
                        });
                    }
                });
            }
            
            const chatsArray = Array.from(this.chats.values())
                .sort((a, b) => (b.lastActivity || 0) - (a.lastActivity || 0));
            
            if (chatsArray.length === 0) {
                chatList.innerHTML = `
                    <div class="no-chats">
                        <div class="no-chats-icon">üí¨</div>
                        <p>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —á–∞—Ç–æ–≤</p>
                        <p style="font-size: 0.9rem; margin-top: 0.5rem;">–ü–æ–¥–æ–∂–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤</p>
                    </div>
                `;
                return;
            }
            
            chatList.innerHTML = chatsArray.map(chat => `
                <div class="chat-user ${this.currentChat === chat.id ? 'active' : ''}" 
                     onclick="chatAdmin.selectChat('${chat.id}')">
                    ${chat.unread > 0 ? `<div class="unread-badge">${chat.unread}</div>` : ''}
                    <div class="chat-user-name">
                        <span>${chat.userName}</span>
                        <span class="chat-user-time">${this.formatTime(chat.lastActivity)}</span>
                    </div>
                    ${chat.lastMessage ? `
                        <div class="chat-user-last" title="${chat.lastMessage}">
                            ${this.truncateText(chat.lastMessage, 50)}
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        selectChat(sessionId) {
            if (!this.chats.has(sessionId)) return;
            
            this.currentChat = sessionId;
            const chat = this.chats.get(sessionId);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º UI
            document.getElementById('current-chat-name').textContent = chat.userName;
            document.getElementById('current-session').style.display = 'block';
            document.getElementById('current-session').querySelector('span').textContent = sessionId.substring(0, 8) + '...';
            
            // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
            document.getElementById('messageInput').disabled = false;
            document.getElementById('sendBtn').disabled = false;
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞
            this.loadChatHistory(sessionId);
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö
            chat.unread = 0;
            this.updateChatList();
            
            // –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
            setTimeout(() => {
                document.getElementById('messageInput').focus();
            }, 100);
        }

        loadChatHistory(sessionId) {
            if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                this.ws.send(JSON.stringify({
                    type: 'get_chat_history',
                    sessionId: sessionId
                }));
            } else {
                // –ï—Å–ª–∏ –Ω–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é
                const chat = this.chats.get(sessionId);
                if (chat) {
                    this.displayChatHistory({
                        sessionId: sessionId,
                        messages: chat.messages,
                        userName: chat.userName
                    });
                }
            }
        }

        displayChatHistory(data) {
            const messagesDiv = document.getElementById('chatMessages');
            messagesDiv.innerHTML = '';
            
            if (!data.messages || data.messages.length === 0) {
                messagesDiv.innerHTML = `
                    <div class="message system">
                        <div class="message-header">
                            <span>ü§ñ –°–∏—Å—Ç–µ–º–∞</span>
                        </div>
                        <p>–ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ —Å –∫–ª–∏–µ–Ω—Ç–æ–º</p>
                        <p style="font-size: 0.9rem; margin-top: 5px;">–≠—Ç–æ –Ω–∞—á–∞–ª–æ —á–∞—Ç–∞ —Å ${data.userName}</p>
                    </div>
                `;
                return;
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
            const uniqueMessages = [];
            const seenMessages = new Set();
            
            data.messages.forEach(msg => {
                const msgKey = `${msg.sender}-${msg.text}-${msg.timestamp}`;
                if (!seenMessages.has(msgKey)) {
                    seenMessages.add(msgKey);
                    uniqueMessages.push(msg);
                }
            });
            
            uniqueMessages.forEach(msg => {
                this.displayMessage({
                    sender: msg.sender,
                    text: msg.text,
                    timestamp: msg.timestamp,
                    sessionId: data.sessionId,
                    userName: msg.sender === 'user' ? data.userName : '–í—ã'
                });
            });
            
            // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –≤–Ω–∏–∑
            setTimeout(() => {
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }, 100);
        }

        displayMessage(data) {
            const messagesDiv = document.getElementById('chatMessages');
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${data.sender}`;
            
            const senderName = data.userName || (data.sender === 'support' ? '–í—ã' : '–ö–ª–∏–µ–Ω—Ç');
            
            messageDiv.innerHTML = `
                <div class="message-header">
                    <span class="message-sender">${senderName}</span>
                    <span class="message-time">${data.timestamp}</span>
                </div>
                <div>${data.text}</div>
            `;
            
            messagesDiv.appendChild(messageDiv);
            
            // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –≤–Ω–∏–∑
            setTimeout(() => {
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }, 50);
        }

        sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message || !this.isConnected || !this.currentChat) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –∏ —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–æ–¥–∫–ª—é—á–µ–Ω—ã');
                return;
            }
            
            if (!this.chats.has(this.currentChat)) return;
            
            const chat = this.chats.get(this.currentChat);
            const timestamp = new Date().toLocaleTimeString('ru-RU');
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é —Å—Ä–∞–∑—É (—á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è)
            chat.messages.push({
                sender: 'support',
                text: message,
                timestamp: timestamp,
                read: true
            });
            chat.lastActivity = new Date();
            chat.lastMessage = message;
            
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            this.displayMessage({
                sender: 'support',
                text: message,
                timestamp: timestamp,
                sessionId: this.currentChat,
                userName: '–í—ã'
            });
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä—É
            if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                this.ws.send(JSON.stringify({
                    type: 'support_message',
                    text: message,
                    sessionId: this.currentChat,
                    timestamp: timestamp
                }));
            }
            
            input.value = '';
            input.focus();
            
            this.updateChatList();
        }

        updateConnectionStatus(connected) {
            const statusEl = document.getElementById('connection-status');
            
            if (connected) {
                statusEl.innerHTML = `<span class="status-indicator online"></span><span>–ü–æ–¥–∫–ª—é—á–µ–Ω–æ</span>`;
            } else {
                statusEl.innerHTML = `<span class="status-indicator offline"></span><span>–û—Ç–∫–ª—é—á–µ–Ω–æ</span>`;
            }
        }

        updateSupportStatus(online) {
            const statusEl = document.getElementById('support-status');
            
            if (online) {
                statusEl.innerHTML = `<span class="status-indicator online"></span><span>–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –æ–Ω–ª–∞–π–Ω</span>`;
            } else {
                statusEl.innerHTML = `<span class="status-indicator offline"></span><span>–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞</span>`;
            }
        }

        showNotification(title, message) {
            if (!("Notification" in window) || Notification.permission !== "granted") return;
            
            new Notification(`üí¨ ${title}`, {
                body: this.truncateText(message, 100),
                icon: 'images/logo.png',
                requireInteraction: false
            });
        }

        truncateText(text, maxLength) {
            if (text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '...';
        }

        formatTime(date) {
            if (!date) return '';
            
            const now = new Date();
            const msgDate = new Date(date);
            
            // –ï—Å–ª–∏ —Å–µ–≥–æ–¥–Ω—è
            if (msgDate.toDateString() === now.toDateString()) {
                return msgDate.toLocaleTimeString('ru-RU', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
            }
            
            // –ï—Å–ª–∏ –≤—á–µ—Ä–∞
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            if (msgDate.toDateString() === yesterday.toDateString()) {
                return '–í—á–µ—Ä–∞';
            }
            
            // –ï—Å–ª–∏ –±–æ–ª–µ–µ 2 –¥–Ω–µ–π –Ω–∞–∑–∞–¥
            return msgDate.toLocaleDateString('ru-RU', {
                day: '2-digit',
                month: '2-digit'
            });
        }

        setupEventListeners() {
            const messageInput = document.getElementById('messageInput');
            
            messageInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    this.sendMessage();
                }
            });
            
            messageInput.addEventListener('input', () => {
                // –ê–≤—Ç–æ-—Ä–∞–∑–º–µ—Ä —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—è
                messageInput.style.height = 'auto';
                messageInput.style.height = Math.min(messageInput.scrollHeight, 150) + 'px';
            });
        }
    }

    const chatAdmin = new ChatAdmin();
    
    function logout() {
        if (confirm('–í—ã–π—Ç–∏ –∏–∑ –ø–∞–Ω–µ–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∏?')) {
            window.location.href = 'index.html';
        }
    }
    
    function sendMessage() {
        chatAdmin.sendMessage();
    }
</script>
</body>
</html>